name: Creates a GitHub Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GITHUB_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"

      - name: Extract changelog for version
        id: changelog
        run: |
          if CHANGELOG=$(bash .github/extract-changelog.sh "${{ steps.version.outputs.version }}" 2>/dev/null); then
            echo "$CHANGELOG" > release_notes.md
          else
            echo "**[View changelog](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.version }}/CHANGELOG.md)**" > release_notes.md
          fi

      - name: Create GitHub Release
        run: |
          PRERELEASE_FLAG=""
          if [[ "${{ steps.version.outputs.version }}" == *-rc* ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi
          gh release create "${{ steps.version.outputs.version }}" \
            --title "${{ steps.version.outputs.version }}" \
            --notes-file release_notes.md \
            $PRERELEASE_FLAG
